# OpenGrep rules for memory and resource management patterns
# Catches common memory leaks, unnecessary clones, and resource management issues

rules:
  # ============================================================================
  # Unnecessary Cloning
  # ============================================================================
  
  - id: unnecessary-clone-in-loop
    patterns:
      - pattern: |
          for $ITEM in $ITER {
            let $CLONED = $VAR.clone();
            // ... use $CLONED ...
          }
      - not:
          - pattern-either:
              - pattern: |
                  // Clone needed for ownership
              - pattern: |
                  // Clone necessary for parallel processing
              - pattern: |
                  // API requirement
              - pattern: |
                  // Ownership transfer
    message: "Cloning in loop. Consider cloning once before loop or using Arc/Rc for shared ownership. If clone is necessary (ownership transfer, API requirement, parallel processing), add a comment explaining why."
    languages: [rust]
    severity: INFO
    metadata:
      category: performance
    paths:
      include:
        - "**/eval/**"
        - "**/backends/**"

  - id: cache-clone-in-loop
    patterns:
      - pattern: |
          for $ITEM in $ITER {
            let $CACHE = $CACHE_MUTEX.lock().unwrap().clone();
            // ... use cache ...
          }
    message: "Cloning cache in loop. Consider cloning once before loop or using Arc for shared access."
    languages: [rust]
    severity: WARNING
    metadata:
      category: performance
    paths:
      include:
        - "**/eval/**"

  # ============================================================================
  # Resource Management
  # ============================================================================
  
  - id: session-acquire-without-release
    patterns:
      - pattern: |
          let $SESSION = $POOL.acquire()?;
          // ... use session ...
          // No explicit release or drop
      - not:
          - pattern: |
              drop($SESSION);
              // or RAII pattern
    message: "Session acquired but not explicitly released. Ensure proper cleanup or use RAII pattern."
    languages: [rust]
    severity: WARNING
    metadata:
      category: resource-management
    paths:
      include:
        - "**/session_pool.rs"
        - "**/backends/**"

  - id: arc-clone-unnecessary
    patterns:
      - pattern: |
          let $ARC1 = Arc::new($DATA);
          let $ARC2 = $ARC1.clone();
          // ... use $ARC2 but could use $ARC1 ...
      - not:
          - pattern: |
              // Arc clone needed for ownership transfer
    message: "Unnecessary Arc clone. Consider using Arc::clone only when ownership transfer is needed."
    languages: [rust]
    severity: INFO
    metadata:
      category: performance
    paths:
      include:
        - "**/eval/**"
        - "**/backends/**"

  # ============================================================================
  # Large Data Structures
  # ============================================================================
  
  - id: large-vec-clone
    patterns:
      - pattern: |
          let $CLONED = $LARGE_VEC.clone();
      - not:
          - pattern: |
              // Clone needed for ownership
    message: "Cloning large Vec. Consider using Arc<Vec<T>> or Rc<Vec<T>> for shared ownership if appropriate."
    languages: [rust]
    severity: INFO
    metadata:
      category: performance
    paths:
      include:
        - "**/eval/**"
        - "**/backends/**"

