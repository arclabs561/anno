name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Limit dataset examples in CI for faster/cheaper runs
  ANNO_MAX_EXAMPLES: 50

jobs:
  # ==========================================================================
  # Quick checks (fast feedback) - runs in parallel
  # ==========================================================================
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo check --all-targets

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      # Note: Using -W instead of -D for warnings to avoid failing on pre-existing lints
      - run: cargo clippy --all-targets

  # ==========================================================================
  # Unit tests - no features (zero-dependency baseline)
  # ==========================================================================
  test-minimal:
    name: Test (minimal)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --lib
      - run: cargo test --test no_features

  # ==========================================================================
  # Evaluation framework tests
  # ==========================================================================
  test-eval:
    name: Test (eval-advanced + discourse)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      
      # Cache downloaded datasets across runs
      - name: Cache datasets
        uses: actions/cache@v4
        with:
          path: ~/.anno_cache
          key: anno-datasets-${{ runner.os }}-v2
          restore-keys: |
            anno-datasets-${{ runner.os }}-
          
      - name: Build with eval features
        run: cargo build --features "eval-advanced discourse"
      - name: Run library tests
        run: cargo test --lib --features "eval-advanced discourse"
      - name: Run eval integration tests
        run: cargo test --test eval_integration --features "eval-advanced"
      - name: Run coref integration tests
        run: cargo test --test coref_integration --features "eval-advanced"
      - name: Run discourse tests
        run: cargo test --test discourse_comprehensive --features "discourse"
      - name: Run new features integration
        run: cargo test --test new_features_integration --features "eval-advanced"

  # ==========================================================================
  # Cross-platform tests (core features only)
  # ==========================================================================
  test-cross-platform:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}
      - name: Build
        run: cargo build --features eval
      - name: Test
        run: cargo test --lib --features eval

  # ==========================================================================
  # ONNX backend tests (Linux only)
  # ==========================================================================
  test-onnx:
    name: Test (ONNX backend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      
      # Cache HuggingFace models (shared across ONNX/Candle)
      - name: Cache HF models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-models-${{ runner.os }}-v2
          restore-keys: |
            hf-models-${{ runner.os }}-
          
      - name: Build ONNX backend
        run: cargo build --features onnx
      - name: Test ONNX (unit)
        run: cargo test --lib --features onnx

  # ==========================================================================
  # Candle backend tests (pure Rust)
  # ==========================================================================
  test-candle:
    name: Test (Candle backend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      
      # Cache HuggingFace models
      - name: Cache HF models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-models-${{ runner.os }}-v2
          restore-keys: |
            hf-models-${{ runner.os }}-
          
      - name: Build Candle backend
        run: cargo build --features candle
      - name: Test Candle (unit)
        run: cargo test --lib --features candle

  # ==========================================================================
  # MSRV (Minimum Supported Rust Version)
  # ==========================================================================
  msrv:
    name: MSRV (1.75)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.75.0
      - uses: Swatinem/rust-cache@v2
      - run: cargo check

  # ==========================================================================
  # Documentation
  # ==========================================================================
  docs:
    name: Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --no-deps --features "eval-full discourse"
        env:
          RUSTDOCFLAGS: -D warnings

  # ==========================================================================
  # Property tests (proptest)
  # ==========================================================================
  proptest:
    name: Property Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run property tests
        run: cargo test --lib --features "eval-advanced" -- proptest
        env:
          PROPTEST_CASES: 100

  # ==========================================================================
  # F1 Regression Tests
  # ==========================================================================
  regression:
    name: F1 Regression
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run regression tests
        run: cargo test --test regression_f1 --features eval -- --nocapture

  # ==========================================================================
  # Examples (compile check)
  # ==========================================================================
  examples:
    name: Examples (build)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build examples (eval)
        run: cargo build --examples --features eval
      - name: Build examples (discourse)
        run: cargo build --example discourse_pipeline --features discourse
      - name: Build examples (abstract anaphora)
        run: cargo build --example abstract_anaphora_eval --features discourse

  # ==========================================================================
  # Comprehensive tests (manual trigger only - requires model downloads)
  # ==========================================================================
  comprehensive:
    name: Comprehensive Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Cache HF models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-models-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            hf-models-${{ runner.os }}-

      - name: Cache datasets
        uses: actions/cache@v4
        with:
          path: ~/.anno_cache
          key: anno-datasets-${{ runner.os }}

      - name: Run all tests including ignored
        run: cargo test --features "eval-full discourse" -- --include-ignored
        continue-on-error: true

      - name: Run abstract anaphora evaluation
        run: cargo run --example abstract_anaphora_eval --features discourse

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-reports
          path: |
            *.html
        if: always()

  # ==========================================================================
  # Security audit
  # ==========================================================================
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Note: Unmaintained crate warnings (number_prefix, paste) are expected
          # This job will show warnings but won't fail the workflow
          # Actual security vulnerabilities would still be reported
